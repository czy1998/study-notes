# 问题记录

1. 如果使用 `docker compose up -d --build` 等构件命令时，遇到报错 `failed to fetch oauth token: Post "https://auth.docker.io/token"`，且错误原因发生在镜像那一步

   - 可以尝试单独拉取镜像后，再进行构建

2. 如果没有远程 docker 仓库，又想把镜像部署到服务器上面，可以使用下列流程上传

   1. 本地构建镜像
      - docker buildx build --platform linux/amd64 -t demo:latest .
      - 这里需要注意，构建的镜像架构要与服务器保持一致，不然运行容器会报错
   2. 将镜像输出为 tar
      - docker save -o demo.tar demo:latest
   3. 传输到服务器上
      - scp -P 22 ~/desktop/demo.tar root@xxx.xx.xxx.xx:/opt/docker
   4. 登录服务器，解析 tar 生成镜像
      - ssh root@xxx.xx.xxx.xx -p 22
      - docker load -i /opt/docker/demo.tar
   5. 检查镜像是否导入成功，构建容器运行项目
      - docker images
      - docker run -d --name demo-container -p 8080:80 demo:latest

3. 前端项目环境变量，我们会在根目录下创建 `.env` 文件，然后在项目中使用 `process.env.POST` 这种形式来调用，但是在打包成镜像后，生成容器并运行，会发现运行失败，是因为容器没能正确的读取环境变量，这时候就需要我们在创建容器时指定环境变量，常用的方式有如下几种：

   - 使用 `--env` 加在容器运行命令上

     ```sh
     docker run -d --name czy-img -p 8989:3000 --env PORT=3000 --env DB_HOST=33.33.111.111 --env DB_PORT=3232 --env DB_USER=postgres --env DB_PASSWORD='EerwkVA@m-e9*CNW' --env DB_NAME=postgres --env SIMILARITY_THRESHOLD=0.7 czy-img-similar:latest
     ```

   - 使用 `.env` + `--env-file` 加在容器运行命令上

     ```sh
     docker run -d --name czy-img -p 8989:3000 --env-file env czy-img-similar:latest
     ```

   - 在 `docker-compose.yml` 文件中等级

     ```yml
     services:
       czy-img:
       image: czy-img-similar:latest
       ports:
         - "8989:3000"
       env_file:
         - env.prod # 读取环境变量文件
     ```

   - 在 `Dockerfile` 中配置

     ```dockerfile
     ENV PORT=3000
     ENV DB_HOST=33.33.111.111
     ENV SIMILARITY_THRESHOLD=0.7
     ```
