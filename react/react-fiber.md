# react-fiber

### 每次视图更新流程如下

1. 组件渲染生成一棵虚拟 dom 树
2. 新旧虚拟 dom 树对比，找出变动的部分（也就是 diff 算法）
3. 为真正改变的部分创建真实 dom，把它们挂载到文档，实现页面重渲染。

### fiber 出现的背景

在数据更新时，react 生成了棵更大的虚拟 dom 树，给第二步 diff 带来的很大压力——我们想要找到真正变化的部分，需要花费更长的时间。
js 占据主线程去做比较，渲染线程便无法做其他工作，用户的交互得不到响应，所以便出现了 react fiber。

### fiber 是什么

是一种数据结构：一个节点有三个指针

1. 指向第一个子节点
2. 指向下一个兄弟节点
3. 指向父节点
   这样使得它可以在 diff 中断恢复以后继续向后进行

### fiber 的作用

将`同步递归无法中断`的更新重构为`异步的可中断`更新

它实现了 4 个具体目标

1. `可中断的渲染`：Fiber 允许将大的渲染任务拆分成多个小的工作单元（Unit of Work），使得 React 可以在空闲时间执行这些小任务。当浏览器需要处理更高优先级的任务时（如用户输入、动画），可以暂停渲染，先处理这些任务，然后再恢复未完成的渲染工作。

2. `优先级调度`：在 Fiber 架构下，React 可以根据不同任务的优先级决定何时更新哪些部分。React 会优先更新用户可感知的部分（如动画、用户输入），而低优先级的任务（如数据加载后的界面更新）可以延后执行。

3. `双缓存树`（Fiber Tree）：Fiber 架构中有两棵 Fiber 树——current fiber tree（当前正在渲染的 Fiber 树）和 work in progress fiber tree（正在处理的 Fiber 树）。React 使用这两棵树来保存更新前后的状态，从而更高效地进行比较和更新。

4. `任务切片`：在浏览器的空闲时间内（利用 requestIdleCallback 思想），React 可以将渲染任务拆分成多个小片段，逐步完成 Fiber 树的构建，避免一次性完成所有渲染任务导致的阻塞。

### fiber 树、virtual DOM 树、组件树

组件树: react 组件之间的层次关系组成的
虚拟 dom 树: 组件树的抽象表示，并且由 react 来追踪组件的变化
Fiber 树: 是 React 用来协调（reconciliation）UI 更新的内部数据结构。Fiber 节点不仅描述了组件树的结构，还包括对任务的优先级、更新状态以及中断恢复的支持。
